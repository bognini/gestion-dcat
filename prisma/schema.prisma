// Prisma Schema for Gestion DCAT ERP
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// AUTHENTICATION & USER MANAGEMENT
// ==========================================

model Utilisateur {
  id                String    @id @default(uuid())
  username          String    @unique
  email             String    @unique
  password          String
  nom               String
  prenom            String?
  avatarUrl         String?
  role              String    @default("technicien") // admin, technicien, marketing, comptable
  isActive          Boolean   @default(true)
  mustChangePassword Boolean  @default(true)
  inviteToken       String?   @unique
  inviteExpires     DateTime?
  resetToken        String?   @unique
  resetExpires      DateTime?
  lastLogin         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  employe           Employe?
  evenementsCreated Evenement[]
  participations    EvenementParticipant[]
  projetsResponsable Projet[]  @relation("ProjetResponsable")
  tachesAssignees   Tache[]
  interventions     InterventionIntervenant[]
  mouvementsOperator MouvementStock[] @relation("Operator")
  mouvementsRequester MouvementStock[] @relation("Requester")
  documentsCreated  Document[]
  sessions          Session[]
  devisCreated      Devis[]
  facturesCreated   Facture[] @relation("FactureCreatedBy")
  paiementsCreated  Paiement[] @relation("PaiementCreatedBy")
  missionParticipations MissionParticipant[]
  tachesMissionResponsable TacheMission[] @relation("TacheMissionResponsable")
  operationsResponsable Operation[] @relation("OperationResponsable")
}

model Session {
  id            String      @id @default(uuid())
  userId        String
  utilisateur   Utilisateur @relation(fields: [userId], references: [id], onDelete: Cascade)
  token         String      @unique
  expiresAt     DateTime
  createdAt     DateTime    @default(now())
  userAgent     String?
  ipAddress     String?

  @@index([userId])
  @@index([token])
}

// ==========================================
// ADMINISTRATION - RH
// ==========================================

model Employe {
  id              String    @id @default(uuid())
  photo           Bytes?
  photoFilename   String?
  photoMime       String?
  nom             String
  prenom          String
  dateNaissance   DateTime?
  dateEmbauche    DateTime
  poste           String
  departement     String?
  cv              Bytes?
  cvFilename      String?
  cvMime          String?
  email           String?
  telephone       String?
  adresse         String?
  salaire         Float?
  typeContrat     String?   // CDI, CDD, Stage, Freelance
  utilisateurId   String?   @unique
  utilisateur     Utilisateur? @relation(fields: [utilisateurId], references: [id])
  absences        DemandeAbsence[]
  fichesTransport FicheTransport[]
  salaires        Salaire[]
  documents       DocumentEmploye[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model DocumentEmploye {
  id          String    @id @default(uuid())
  employeId   String
  employe     Employe   @relation(fields: [employeId], references: [id], onDelete: Cascade)
  nom         String
  type        String    // cv, diplome, contrat, piece_identite, autre
  fichier     String    // File path
  mimeType    String?
  taille      Int?      // File size in bytes
  notes       String?
  createdAt   DateTime  @default(now())

  @@index([employeId])
}

model DemandeAbsence {
  id           String    @id @default(uuid())
  employeId    String
  employe      Employe   @relation(fields: [employeId], references: [id], onDelete: Cascade)
  type         String    // conge_paye, conge_sans_solde, permission, maladie, maternite
  dateDebut    DateTime
  dateFin      DateTime
  motif        String?
  statut       String    @default("en_attente") // en_attente, approuve, refuse
  commentaire  String?
  documentPath String?   // Path to uploaded justification document
  documentName String?   // Original filename
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model FicheTransport {
  id          String    @id @default(uuid())
  date        DateTime  @default(now())
  employeId   String
  employe     Employe   @relation(fields: [employeId], references: [id], onDelete: Cascade)
  lignes      LigneTransport[]
  totalCout   Float     @default(0)
  statut      String    @default("impaye") // impaye, paye
  commentaire String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model LigneTransport {
  id              String          @id @default(uuid())
  ficheId         String
  fiche           FicheTransport  @relation(fields: [ficheId], references: [id], onDelete: Cascade)
  depart          String
  arrivee         String
  typeClient      String          // client, particulier
  partenaireId    String?
  partenaire      Partenaire?     @relation(fields: [partenaireId], references: [id])
  particulierNom  String?         // Name when typeClient is 'particulier'
  cout            Float
  createdAt       DateTime        @default(now())

  @@index([ficheId])
  @@index([partenaireId])
}

// ==========================================
// ADMINISTRATION - REMBOURSEMENTS (Client Debts)
// ==========================================

model Remboursement {
  id              String      @id @default(uuid())
  partenaireId    String
  partenaire      Partenaire  @relation(fields: [partenaireId], references: [id])
  montantTotal    Float       // Total amount owed
  montantPaye     Float       @default(0) // Amount paid so far
  motif           String      // Reason for the debt (invoice number, intervention, etc.)
  reference       String?     // Reference number
  dateEcheance    DateTime?   // Due date
  statut          String      @default("en_cours") // en_cours, partiel, solde, contentieux
  notes           String?
  paiements       PaiementRemboursement[]
  documents       DocumentRemboursement[]
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([partenaireId])
  @@index([statut])
}

model DocumentRemboursement {
  id              String        @id @default(uuid())
  remboursementId String
  remboursement   Remboursement @relation(fields: [remboursementId], references: [id], onDelete: Cascade)
  nom             String
  fichier         String        // File path or URL
  type            String?       // MIME type
  taille          Int?          // File size in bytes
  createdAt       DateTime      @default(now())

  @@index([remboursementId])
}

model PaiementRemboursement {
  id              String        @id @default(uuid())
  remboursementId String
  remboursement   Remboursement @relation(fields: [remboursementId], references: [id], onDelete: Cascade)
  montant         Float
  datePaiement    DateTime      @default(now())
  modePaiement    String        // especes, virement, cheque, mobile_money
  reference       String?       // Transaction reference
  notes           String?
  createdAt       DateTime      @default(now())

  @@index([remboursementId])
}

// ==========================================
// ADMINISTRATION - FICHES DE MISSION
// ==========================================

model FicheMission {
  id            String          @id @default(uuid())
  reference     String          @unique // FM-YYYY-XXXX
  titre         String
  description   String?
  projetId      String?
  projet        Projet?         @relation(fields: [projetId], references: [id])
  destination   String          // City/location of mission
  dateDepart    DateTime
  dateRetour    DateTime?
  statut        String          @default("planifiee") // planifiee, en_cours, terminee, annulee
  budget        Float?
  depensesReelles Float?
  objectifs     String?
  notes         String?
  participants  MissionParticipant[]
  taches        TacheMission[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([projetId])
  @@index([statut])
}

model TacheMission {
  id            String        @id @default(uuid())
  intitule      String
  description   String?
  statut        String        @default("a_faire") // a_faire, en_cours, termine
  dureeMinutes  Int?          // Time spent in minutes
  missionId     String
  mission       FicheMission  @relation(fields: [missionId], references: [id], onDelete: Cascade)
  responsableId String?
  responsable   Utilisateur?  @relation("TacheMissionResponsable", fields: [responsableId], references: [id])
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([missionId])
  @@index([responsableId])
}

model MissionParticipant {
  id              String        @id @default(uuid())
  missionId       String
  mission         FicheMission  @relation(fields: [missionId], references: [id], onDelete: Cascade)
  utilisateurId   String
  utilisateur     Utilisateur   @relation(fields: [utilisateurId], references: [id])
  role            String?       // Chef de mission, Technicien, etc.
  perDiem         Float?        // Daily allowance
  notes           String?
  createdAt       DateTime      @default(now())

  @@unique([missionId, utilisateurId])
  @@index([missionId])
  @@index([utilisateurId])
}

// ==========================================
// ADMINISTRATION - CONTRATS CLIENTS
// ==========================================

model ContratClient {
  id              String        @id @default(uuid())
  numero          String        @unique
  titre           String
  partenaireId    String
  partenaire      Partenaire    @relation(fields: [partenaireId], references: [id])
  type            String        // maintenance, service, abonnement
  montantMensuel  Float?
  montantAnnuel   Float?
  dateDebut       DateTime
  dateFin         DateTime?
  modePaiement    String        @default("mensuel") // mensuel, trimestriel, annuel
  jourPaiement    Int?          // Day of month for payment
  statut          String        @default("actif") // actif, suspendu, resilie, expire
  description     String?
  notes           String?
  documentPath    String?       // Path to uploaded document
  documentName    String?       // Original filename
  echeances       EcheanceContrat[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([partenaireId])
  @@index([statut])
}

model EcheanceContrat {
  id              String        @id @default(uuid())
  contratId       String
  contrat         ContratClient @relation(fields: [contratId], references: [id], onDelete: Cascade)
  mois            DateTime      // Month of the payment
  montant         Float
  statut          String        @default("a_payer") // a_payer, paye, retard
  datePaiement    DateTime?
  reference       String?       // Payment reference
  notes           String?
  createdAt       DateTime      @default(now())

  @@index([contratId])
  @@index([statut])
}

// ==========================================
// ADMINISTRATION - SALAIRES
// ==========================================

model Salaire {
  id              String      @id @default(uuid())
  employeId       String
  employe         Employe     @relation(fields: [employeId], references: [id])
  mois            DateTime    // Month/Year of salary
  salaireBase     Float
  primes          Float       @default(0)
  deductions      Float       @default(0)
  netAPayer       Float
  statut          String      @default("en_attente") // en_attente, paye
  datePaiement    DateTime?
  modePaiement    String?     // virement, especes, cheque
  notes           String?
  documentPath    String?     // Path to pay slip document
  documentName    String?     // Original filename
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([employeId, mois])
  @@index([employeId])
  @@index([mois])
  @@index([statut])
}

// ==========================================
// ADMINISTRATION - ABONNEMENTS (Subscriptions)
// ==========================================

model Abonnement {
  id              String      @id @default(uuid())
  nom             String      // Internet, Hébergement, Électricité, etc.
  type            String      // internet, hosting, electricity, water, software, ai, antivirus, other
  fournisseur     String      // Provider name
  montant         Float       // Monthly/Annual amount
  periodicite     String      @default("mensuel") // mensuel, annuel
  dateDebut       DateTime
  dateProchainePaiement DateTime?
  dateExpiration  DateTime?   // For subscriptions with end dates
  statut          String      @default("actif") // actif, suspendu, expire, resilie
  reference       String?     // Contract/Account reference
  notes           String?
  alerteJours     Int         @default(7) // Days before deadline to alert
  echeances       EcheanceAbonnement[]
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([type])
  @@index([statut])
  @@index([dateProchainePaiement])
}

model EcheanceAbonnement {
  id              String      @id @default(uuid())
  abonnementId    String
  abonnement      Abonnement  @relation(fields: [abonnementId], references: [id], onDelete: Cascade)
  dateEcheance    DateTime
  montant         Float
  statut          String      @default("a_payer") // a_payer, paye, retard
  datePaiement    DateTime?
  reference       String?     // Payment reference
  documentPath    String?     // Path to paid invoice document
  documentName    String?     // Original filename
  notes           String?
  createdAt       DateTime    @default(now())

  @@index([abonnementId])
  @@index([statut])
  @@index([dateEcheance])
}

// ==========================================
// ADMINISTRATION - CONTRATS PRESTATAIRES
// ==========================================

model ContratPrestataire {
  id              String      @id @default(uuid())
  numero          String      @unique
  partenaireId    String
  partenaire      Partenaire  @relation(fields: [partenaireId], references: [id])
  objet           String      // Subject of the contract
  description     String?
  montant         Float
  dateDebut       DateTime
  dateFin         DateTime?
  delaiExecution  String?     // Execution deadline
  conditionsPaiement String?  // Payment terms
  statut          String      @default("en_cours") // brouillon, en_cours, termine, annule
  documentPath    String?     // Path to uploaded contract document
  documentName    String?     // Original filename
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([partenaireId])
  @@index([statut])
}

// ==========================================
// ADMINISTRATION - DOCUMENTS
// ==========================================

model Dossier {
  id          String      @id @default(uuid())
  nom         String
  type        String      // administratif, financier, comptable, rh, contrat
  description String?
  parentId    String?
  parent      Dossier?    @relation("SubDossiers", fields: [parentId], references: [id])
  subDossiers Dossier[]   @relation("SubDossiers")
  documents   Document[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([type])
  @@index([parentId])
}

model Document {
  id          String      @id @default(uuid())
  nom         String
  description String?
  type        String      // administratif, financier, comptable, rh, contrat
  fichier     Bytes
  filename    String
  mime        String
  taille      Int?
  dossierId   String?
  dossier     Dossier?    @relation(fields: [dossierId], references: [id])
  createdById String?
  createdBy   Utilisateur? @relation(fields: [createdById], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([type])
  @@index([dossierId])
}

// ==========================================
// CALENDRIER
// ==========================================

model Evenement {
  id            String    @id @default(uuid())
  titre         String
  type          String    // intervention, reunion_hebdo, projet, mission, teletravail, autre
  description   String?
  dateDebut     DateTime
  dateFin       DateTime
  journeeEntiere Boolean  @default(false)
  dureeEstimee  Int?      // en minutes
  lieu          String?
  couleur       String?
  rappel        Boolean   @default(false)
  rappelDelai   Int?      // minutes avant l'événement
  rappelEnvoye  Boolean   @default(false)
  recurrence    String?   // quotidien, hebdomadaire, mensuel, annuel
  createdById   String
  createdBy     Utilisateur @relation(fields: [createdById], references: [id])
  participants  EvenementParticipant[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([dateDebut])
  @@index([type])
}

model EvenementParticipant {
  id          String      @id @default(uuid())
  evenementId String
  evenement   Evenement   @relation(fields: [evenementId], references: [id], onDelete: Cascade)
  userId      String
  utilisateur Utilisateur @relation(fields: [userId], references: [id])
  statut      String      @default("invite") // invite, confirme, decline

  @@unique([evenementId, userId])
}

// ==========================================
// GESTION DE STOCK
// ==========================================

model Categorie {
  id          String    @id @default(uuid())
  nom         String    @unique
  description String?
  familles    Famille[]
  produits    Produit[]
}

model Famille {
  id          String     @id @default(uuid())
  nom         String
  description String?
  categorieId String
  categorie   Categorie  @relation(fields: [categorieId], references: [id])
  modeles     Modele[]
  produits    Produit[]

  @@unique([nom, categorieId])
  @@index([categorieId])
}

model Marque {
  id          String    @id @default(uuid())
  nom         String    @unique
  description String?
  modeles     Modele[]
  produits    Produit[]
}

model Modele {
  id          String    @id @default(uuid())
  nom         String
  description String?
  familleId   String
  famille     Famille   @relation(fields: [familleId], references: [id])
  marqueId    String
  marque      Marque    @relation(fields: [marqueId], references: [id])
  produits    Produit[]

  @@unique([nom, marqueId])
  @@index([familleId])
}

model Emplacement {
  id          String    @id @default(uuid())
  nom         String    @unique
  description String?
  bureau      String?   // CEO OFFICE, BUREAU TECHNICIENS, ATELIER
  armoire     String?   // Armoire, GRILLE
  aile        String?   // Droite, Gauche (for Armoire only)
  etagere     String?   // 1, 2, 3, 4, 5 or Mobile, 1-10 for ATELIER
  produits    Produit[]
}

model Fournisseur {
  id         String           @id @default(uuid())
  nom        String           @unique
  contact    String?
  email      String?
  telephone  String?
  adresse    String?
  mouvements MouvementStock[]
}

model Produit {
  id              String           @id @default(uuid())
  nom             String
  description     String?
  sku             String?          @unique
  gtin            String?          @unique
  poids           Float?
  couleur         String?
  prixAchat       Float?
  coutLogistique  Float?
  prixVenteMin    Float?           // Prix de vente minimum
  prixVente       Float?
  quantite        Int              @default(0)
  serialNumbers   String[]         @default([])
  tags            String[]         @default([])
  seuilAlerte     Int?
  marqueId        String?
  marque          Marque?          @relation(fields: [marqueId], references: [id])
  categorieId     String?
  categorie       Categorie?       @relation(fields: [categorieId], references: [id])
  familleId       String?
  famille         Famille?         @relation(fields: [familleId], references: [id])
  modeleId        String?
  modele          Modele?          @relation(fields: [modeleId], references: [id])
  emplacementId   String?
  emplacement     Emplacement?     @relation(fields: [emplacementId], references: [id])
  mouvements      MouvementStock[]
  images          ProduitImage[]
  devisLignes     DevisLigne[]
  factureLignes   FactureLigne[]
  commandeLignes  CommandeLigne[]
  emarket         ProduitEmarket?

  // Additional fields (etat and numeroSerie moved to MouvementStock)
  dateAchat       DateTime?
  garantieFin     DateTime?
  notes           String?

  // E-commerce fields
  isPublished     Boolean          @default(false)
  isFeatured      Boolean          @default(false)
  seoSlug         String?          @unique
  promoPrice      Float?
  promoStart      DateTime?
  promoEnd        DateTime?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([marqueId])
  @@index([categorieId])
  @@index([familleId])
  @@index([modeleId])
  @@index([isPublished])
}

model ProduitImage {
  id        String   @id @default(uuid())
  produitId String
  produit   Produit  @relation(fields: [produitId], references: [id], onDelete: Cascade)
  filename  String
  mime      String
  data      Bytes
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  @@index([produitId])
}

model MouvementStock {
  id                    String       @id @default(uuid())
  date                  DateTime     @default(now())
  type                  String       // ENTREE, SORTIE
  quantite              Int
  produitId             String
  produit               Produit      @relation(fields: [produitId], references: [id])
  utilisateurId         String
  utilisateur           Utilisateur  @relation("Operator", fields: [utilisateurId], references: [id])
  demandeurId           String?
  demandeur             Utilisateur? @relation("Requester", fields: [demandeurId], references: [id])
  fournisseurId         String?
  fournisseur           Fournisseur? @relation(fields: [fournisseurId], references: [id])
  destination           String?        // For SORTIE: client name or partenaire
  destinationType       String?        // PARTENAIRE or PARTICULIER
  destinationContact    String?        // Contact info for PARTICULIER
  partenaireDstId       String?        // If destination is a partenaire
  partenaireDst         Partenaire?    @relation(fields: [partenaireDstId], references: [id])
  projetId              String?
  projet                Projet?        @relation(fields: [projetId], references: [id])
  serialNumbers         String[]       @default([])
  etat                  String?        // neuf, occasion, reconditionne (for ENTREE)
  justificatifFilename  String?
  justificatifMime      String?
  justificatifData      Bytes?
  prixVenteDefinitif    Float?
  commentaire           String?

  @@index([produitId])
  @@index([date])
}

// ==========================================
// TECHNIQUE - PARTENAIRES & CONTRATS
// ==========================================

model Partenaire {
  id            String         @id @default(uuid())
  nom           String         @unique
  type          String?        // client, fournisseur, partenaire, prestataire
  secteur       String?
  adresse       String?
  ville         String?
  pays          String?
  email         String?
  telephone1    String?
  telephone2    String?
  devis         Devis[]
  factures      Facture[]      @relation("FacturePartenaire")
  siteWeb       String?
  notes         String?
  contacts      Contact[]
  projets       Projet[]
  contrats      Contrat[]
  interventions Intervention[]
  mouvements    MouvementStock[]
  clients       Client[]       @relation("ClientPartenaire")
  lignesTransport LigneTransport[]
  remboursements  Remboursement[]
  contratsClients ContratClient[]
  contratsPrestataires ContratPrestataire[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Contact {
  id            String         @id @default(uuid())
  nom           String
  prenom        String?
  fonction      String?
  email         String?
  telephone     String?
  estPrincipal  Boolean        @default(false)
  partenaireId  String
  partenaire    Partenaire     @relation(fields: [partenaireId], references: [id], onDelete: Cascade)
  interventionsSupervisees Intervention[]
  createdAt     DateTime       @default(now())

  @@index([partenaireId])
}

model Contrat {
  id            String         @id @default(uuid())
  numero        String         @unique
  titre         String
  type          String?        // maintenance, service, vente, location
  partenaireId  String
  partenaire    Partenaire     @relation(fields: [partenaireId], references: [id])
  dateDebut     DateTime
  dateFin       DateTime?
  montant       Float?
  statut        String         @default("actif") // actif, expire, resilie
  fichier       Bytes?
  filename      String?
  mime          String?
  description   String?
  interventions Intervention[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([partenaireId])
  @@index([statut])
}

// ==========================================
// TECHNIQUE - PROJETS
// ==========================================

model Projet {
  id                String           @id @default(uuid())
  nom               String
  reference         String?          @unique
  partenaireId      String
  partenaire        Partenaire       @relation(fields: [partenaireId], references: [id])
  categorie         String           // audiovisuel, informatique, domotique, energie
  type              String           // externe, interne, mission
  devisEstimatif    Float?
  dureeJours        Int?
  dateDebut         DateTime?
  dateFinEstimative DateTime?
  dateFinReelle     DateTime?
  etat              String           @default("planifie") // planifie, en_cours, termine, annule, bloque
  lieu              String?
  responsableId     String?
  responsable       Utilisateur?     @relation("ProjetResponsable", fields: [responsableId], references: [id])
  description       String?
  priorite          String           @default("moyenne") // basse, moyenne, haute, critique
  progression       Int              @default(0) // 0-100
  operations        Operation[]
  livrables         Livrable[]
  mouvements        MouvementStock[]
  documents         ProjetDocument[]
  images            ProjetImage[]
  imageFolders      ProjetImageFolder[]
  ficheMissions     FicheMission[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([partenaireId])
  @@index([etat])
  @@index([responsableId])
}

model ProjetImageFolder {
  id          String        @id @default(uuid())
  projetId    String
  projet      Projet        @relation(fields: [projetId], references: [id], onDelete: Cascade)
  nom         String
  description String?
  images      ProjetImage[]
  createdAt   DateTime      @default(now())

  @@index([projetId])
}

model ProjetImage {
  id          String            @id @default(uuid())
  projetId    String
  projet      Projet            @relation(fields: [projetId], references: [id], onDelete: Cascade)
  folderId    String?
  folder      ProjetImageFolder? @relation(fields: [folderId], references: [id], onDelete: Cascade)
  description String?
  fichier     Bytes
  filename    String
  mime        String
  createdAt   DateTime          @default(now())

  @@index([projetId])
  @@index([folderId])
}

model ProjetDocument {
  id        String   @id @default(uuid())
  projetId  String
  projet    Projet   @relation(fields: [projetId], references: [id], onDelete: Cascade)
  nom       String
  fichier   Bytes
  filename  String
  mime      String
  createdAt DateTime @default(now())

  @@index([projetId])
}

model Operation {
  id            String       @id @default(uuid())
  intitule      String
  description   String?
  statut        String       @default("planifie") // planifie, en_cours, termine, annule
  priorite      String       @default("moyenne") // basse, moyenne, haute
  dateDebut     DateTime?
  dateFin       DateTime?
  dateLimite    DateTime?
  progression   Int          @default(0)
  projetId      String
  projet        Projet       @relation(fields: [projetId], references: [id], onDelete: Cascade)
  responsableId String?
  responsable   Utilisateur? @relation("OperationResponsable", fields: [responsableId], references: [id])
  taches        Tache[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([projetId])
  @@index([statut])
  @@index([responsableId])
}

model Tache {
  id            String       @id @default(uuid())
  intitule      String
  description   String?
  statut        String       @default("planifie") // planifie, en_cours, termine, annule
  priorite      String       @default("moyenne") // basse, moyenne, haute
  dateDebut     DateTime?
  dateFin       DateTime?
  dateLimite    DateTime?
  dureeMinutes  Int?         // Time spent in minutes
  operationId   String
  operation     Operation    @relation(fields: [operationId], references: [id], onDelete: Cascade)
  assigneId     String?
  assigne       Utilisateur? @relation(fields: [assigneId], references: [id])
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([operationId])
  @@index([assigneId])
}

model Livrable {
  id          String   @id @default(uuid())
  libelle     String
  description String?
  statut      String   @default("en_attente") // en_attente, approuve, rejete
  fichier     Bytes?
  filename    String?
  mime        String?
  projetId    String
  projet      Projet   @relation(fields: [projetId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projetId])
}

// ==========================================
// TECHNIQUE - INTERVENTIONS
// ==========================================

model Intervention {
  id                    String    @id @default(uuid())
  reference             String?   @unique
  date                  DateTime
  partenaireId          String
  partenaire            Partenaire @relation(fields: [partenaireId], references: [id])
  contratId             String?
  contrat               Contrat?   @relation(fields: [contratId], references: [id])
  problemeSignale       String
  typeMaintenance       String     // corrective, preventive, planifiee
  typeDefaillance       String?    // logicielle, materielle, electrique
  causeDefaillance      String?    // usure_normale, defaut_utilisateur, defaut_produit, autre
  rapport               String?
  recommandations       String?
  dureeMinutes          Int?
  modeIntervention      String?    // sur_site, a_distance, hybride
  lieu                  String?
  statut                String     @default("a_faire") // a_faire, en_cours, en_attente, termine
  superviseurId         String?
  superviseur           Contact?   @relation(fields: [superviseurId], references: [id])
  ficheSignee           Bytes?
  ficheSigneeFilename   String?
  ficheSigneeMime       String?
  intervenants          InterventionIntervenant[]
  documents             InterventionDocument[]
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  @@index([partenaireId])
  @@index([date])
  @@index([statut])
}

model InterventionIntervenant {
  id             String       @id @default(uuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  userId         String
  utilisateur    Utilisateur  @relation(fields: [userId], references: [id])

  @@unique([interventionId, userId])
}

model InterventionDocument {
  id             String       @id @default(uuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  nom            String
  fichier        Bytes
  filename       String
  mime           String
  createdAt      DateTime     @default(now())

  @@index([interventionId])
}

// ==========================================
// PARAMETRES & CONFIGURATION
// ==========================================

model MailConfig {
  id                 String   @id @default(uuid())
  smtpHost           String?
  smtpPort           Int?
  smtpUser           String?
  smtpPass           String?  // Should be encrypted
  smtpFrom           String?
  smtpFromName       String?
  smtpSecure         Boolean  @default(true)
  notificationEmails String[]
  updatedAt          DateTime @updatedAt
}

model NotificationEmailList {
  id       String   @id @default(uuid())
  eventKey String   @unique
  label    String?
  emails   String[]
  updatedAt DateTime @updatedAt
}

model AppConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

// ==========================================
// ADMINISTRATION - DEVIS (QUOTES)
// ==========================================

model Devis {
  id                String        @id @default(uuid())
  reference         String        @unique // Format: YYYYMM/DD-NN or YYYYMM/DD-NN-A for revisions
  date              DateTime      @default(now())
  objet             String        // Titre/description du devis
  
  // Revision tracking
  parentDevisId     String?       // ID of the original devis if this is a revision
  parentDevis       Devis?        @relation("DevisRevisions", fields: [parentDevisId], references: [id])
  revisions         Devis[]       @relation("DevisRevisions")
  revisionLetter    String?       // A, B, C, etc. - null for original
  
  // Client info
  clientType        String        // partenaire, particulier, entreprise
  clientNom         String
  clientAdresse     String?
  clientVille       String?
  clientPays        String        @default("Côte d'Ivoire")
  clientEmail       String?
  clientTelephone   String?
  partenaireId      String?
  partenaire        Partenaire?   @relation(fields: [partenaireId], references: [id])
  
  // Terms
  delaiLivraison    String?       // ex: "1 semaine", "15 jours"
  conditionLivraison String?      // ex: "A convenir ensemble"
  validiteOffre     Int           @default(30) // jours
  garantie          String?       // ex: "1 AN"
  
  // Status
  statut            String        @default("brouillon") // brouillon, envoye, accepte, refuse, expire
  
  // PDF
  pdfGenerated      Boolean       @default(false)
  pdfData           Bytes?
  pdfFilename       String?
  
  // Totals (calculated)
  totalHT           Float         @default(0)
  totalTTC          Float         @default(0)
  tauxTVA           Float         @default(0) // 0 = pas de TVA (HT seulement)
  
  // Relations
  lignes            DevisLigne[]
  factures          Facture[]
  createdById       String
  createdBy         Utilisateur   @relation(fields: [createdById], references: [id])
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([reference])
  @@index([date])
  @@index([statut])
  @@index([clientNom])
}

model DevisLigne {
  id           String   @id @default(uuid())
  devisId      String
  devis        Devis    @relation(fields: [devisId], references: [id], onDelete: Cascade)
  ordre        Int      @default(0)
  
  // Référence produit (optionnel - peut être ligne libre)
  produitId    String?
  produit      Produit? @relation(fields: [produitId], references: [id])
  reference    String   // REF code (ex: INFO-RAM, INFO-DDI, MO-TVX)
  
  // Description
  designation  String   // Description principale
  details      String?  // Sous-description (italique dans le PDF)
  
  // Quantité et prix
  quantite     Int      @default(1)
  unite        String   @default("u") // u, h, j, mois, etc.
  prixUnitaire Float
  montant      Float    // quantite * prixUnitaire
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([devisId])
}

// ==========================================
// ADMINISTRATION - FACTURES (INVOICES)
// ==========================================

model Facture {
  id                String          @id @default(uuid())
  reference         String          @unique // Format: FAC-YYYY-XXXX
  date              DateTime        @default(now())
  dateEcheance      DateTime?
  
  // Client info (copied from devis or entered manually)
  clientNom         String
  clientAdresse     String?
  clientVille       String?
  clientPays        String          @default("Côte d'Ivoire")
  clientEmail       String?
  clientTelephone   String?
  
  // Link to partenaire (optional)
  partenaireId      String?
  partenaire        Partenaire?     @relation("FacturePartenaire", fields: [partenaireId], references: [id])
  
  // Link to devis (optional - facture can come from devis)
  devisId           String?
  devis             Devis?          @relation(fields: [devisId], references: [id])
  
  // Content
  objet             String?
  lignes            FactureLigne[]
  
  // Totals
  totalHT           Float           @default(0)
  totalTVA          Float           @default(0)
  totalTTC          Float           @default(0)
  
  // Payment
  montantPaye       Float           @default(0)
  resteAPayer       Float           @default(0)
  statut            String          @default("brouillon") // brouillon, envoyee, payee_partiellement, payee, annulee
  
  // Payments
  paiements         Paiement[]
  
  // Meta
  notes             String?
  documentPath      String?       // Path to uploaded document
  documentName      String?       // Original filename
  createdById       String?
  createdBy         Utilisateur?    @relation("FactureCreatedBy", fields: [createdById], references: [id])
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([partenaireId])
  @@index([devisId])
  @@index([statut])
  @@index([date])
}

model FactureLigne {
  id           String   @id @default(uuid())
  factureId    String
  facture      Facture  @relation(fields: [factureId], references: [id], onDelete: Cascade)
  ordre        Int      @default(0)
  
  produitId    String?
  produit      Produit? @relation(fields: [produitId], references: [id])
  reference    String
  designation  String
  details      String?
  
  quantite     Int      @default(1)
  unite        String   @default("u")
  prixUnitaire Float
  montant      Float
  
  createdAt    DateTime @default(now())

  @@index([factureId])
}

// ==========================================
// ADMINISTRATION - PAIEMENTS (PAYMENTS)
// ==========================================

model Paiement {
  id           String    @id @default(uuid())
  reference    String    @unique // Format: PAY-YYYY-XXXX
  date         DateTime  @default(now())
  
  factureId    String
  facture      Facture   @relation(fields: [factureId], references: [id], onDelete: Cascade)
  
  montant      Float
  modePaiement String    // especes, mobile_money, virement, carte, cheque
  
  // Details
  banque       String?
  numeroCheque String?
  reference_ext String?  // Reference externe (transaction mobile money, etc.)
  notes        String?
  documentPath String?   // Path to uploaded document (proof of payment)
  documentName String?   // Original filename
  
  createdById  String?
  createdBy    Utilisateur? @relation("PaiementCreatedBy", fields: [createdById], references: [id])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([factureId])
  @@index([date])
}

// ==========================================
// E-MARKET - BOUTIQUE EN LIGNE
// ==========================================

model Client {
  id           String       @id @default(uuid())
  type         String       @default("particulier") // particulier, partenaire
  nom          String
  prenom       String?
  email        String?
  telephone    String       // Required
  adresse      String?
  ville        String?
  pays         String       @default("Côte d'Ivoire")
  isActive     Boolean      @default(true)
  partenaireId String?
  partenaire   Partenaire?  @relation("ClientPartenaire", fields: [partenaireId], references: [id])
  commandes    Commande[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([telephone])
  @@index([nom])
}

model Commande {
  id              String          @id @default(uuid())
  reference       String          @unique // CMD-YYYY-XXXX
  date            DateTime        @default(now())
  clientId        String
  client          Client          @relation(fields: [clientId], references: [id])
  statut          String          @default("en_attente") // en_attente, confirmee, en_preparation, expediee, livree, annulee
  modePaiement    String?         // especes, mobile_money, virement, carte
  statutPaiement  String          @default("en_attente") // en_attente, partiel, paye
  montantPaye     Float           @default(0)
  adresseLivraison String?
  notes           String?
  documentPath    String?         // Path to uploaded document
  documentName    String?         // Original filename
  lignes          CommandeLigne[]
  totalHT         Float           @default(0)
  totalTTC        Float           @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([clientId])
  @@index([statut])
  @@index([date])
}

model CommandeLigne {
  id           String    @id @default(uuid())
  commandeId   String
  commande     Commande  @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  produitId    String
  produit      Produit   @relation(fields: [produitId], references: [id])
  designation  String
  quantite     Int       @default(1)
  prixUnitaire Float
  montant      Float
  createdAt    DateTime  @default(now())

  @@index([commandeId])
}

model ProduitEmarket {
  id           String    @id @default(uuid())
  produitId    String    @unique
  produit      Produit   @relation(fields: [produitId], references: [id])
  isPublished  Boolean   @default(false)
  prixEmarket  Float?    // Prix spécifique e-market (sinon prixVente du produit)
  enPromotion  Boolean   @default(false)
  prixPromo    Float?
  description  String?   // Description marketing
  ordre        Int       @default(0) // Ordre d'affichage
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([isPublished])
}

model Charge {
  id          String    @id @default(uuid())
  nom         String
  description String?
  montant     Float
  type        String    // loyer, electricite, eau, internet, telephone, assurance, abonnement, autre
  frequence   String    // mensuel, trimestriel, semestriel, annuel
  dateDebut   DateTime
  dateFin     DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Depense {
  id           String   @id @default(uuid())
  description  String
  montant      Float
  categorie    String   // fournitures, transport, repas, maintenance, marketing, formation, autre
  date         DateTime
  justificatif String?  // path to uploaded file
  createdAt    DateTime @default(now())
}

model MouvementCaisse {
  id          String   @id @default(uuid())
  type        String   // entree, sortie
  montant     Float
  description String?
  justificatif String? // path to uploaded file
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
}
